<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="icon" href="https://cdn.edisonlee55.com/edisonlee55/resources/photo/cb3ad2f4-13f3-413e-9b53-83f6d6d590a2.png">
    <title>Record Marriage|MoeMarry</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
        crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="css/mdb.min.css" rel="stylesheet">
    <!-- Your custom styles (optional) -->
    <link href="css/style.min.css" rel="stylesheet">
    <style type="text/css">
        html,
        body,
        header,
        .view {
            height: 100%;
        }

        @media (max-width: 740px) {
            html,
            body,
            header,
            .view {
                height: 1000px;
            }
        }

        @media (min-width: 800px) and (max-width: 850px) {
            html,
            body,
            header,
            .view {
                height: 650px;
            }
        }

        @media (min-width: 800px) and (max-width: 850px) {
            .navbar:not(.top-nav-collapse) {
                background: #1C2331 !important;
            }
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar top-nav-collapse">
        <div class="container">

            <!-- Brand -->
            <a class="navbar-brand" href="index.html">
                <strong>MoeMarry</strong>
            </a>

            <!-- Collapse -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Links -->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">

                <!-- Left -->
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Record Marriage
                            <span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="search.html">Search Record</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="edit.html">Edit Record</a>
                    </li>
                </ul>

                <!-- Right -->
                <ul class="navbar-nav nav-flex-icons">
                    <li class="nav-item">
                        <a href="https://github.com/edisonlee55/MoeMarry" class="nav-link border border-light rounded">
                            <i class="fab fa-github mr-2"></i>View Source
                        </a>
                    </li>
                </ul>

            </div>

        </div>
    </nav>
    <!-- Navbar -->


    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--Main layout-->
    <main>
        <div class="container">
            <div id="status">
                <div id="onlineStatus" style="background:#df6b5b;position:relative;width:12px;height:12px;text-align:center;border-radius:100%;transition:background-color .3s ease"></div>
                <p id="statusText">Web3: Unknown</p>
                <p id="netStatus"></p>
                <p id="address"></p>
            </div>
            <!-- Card -->
            <div class="card">

                <!-- Card body -->
                <div class="card-body" id="formBody">

                    <!-- Material form register -->
                    <form>
                        <p class="h4 text-center py-4">Record Marriage</p>

                        <!-- Material input text -->
                        <div class="md-form">
                            <i class="material-icons prefix grey-text">face</i>
                            <input type="text" id="partner1" class="form-control">
                            <label for="partner1" class="font-weight-light">Parter 1 Name</label>
                        </div>

                        <!-- Material input text -->
                        <div class="md-form">
                            <i class="material-icons prefix grey-text">face</i>
                            <input type="text" id="partner2" class="form-control">
                            <label for="partner2" class="font-weight-light">Parter 2 Name</label>
                        </div>

                        <!-- Material input email -->
                        <div class="md-form">
                            <i class="material-icons prefix grey-text">date_range</i>
                            <input type="date" id="marriageDate" class="form-control">
                            <label for="marriageDate" class="font-weight-light active">Marriage Date</label>
                        </div>

                        <div class="text-center py-4 mt-3">
                            <button class="btn btn-blue" id="recordMarriage" type="submit">Á¥ÄÈåÑ üìù</button>
                        </div>
                    </form>
                    <!-- Material form register -->
                    <p id="TxID"></p>
                </div>
                <!-- Card body -->

            </div>
            <!-- Card -->


        </div>
    </main>
    <!--Main layout-->

    <!--Footer-->
    <footer class="page-footer text-center font-small mt-4">

        <hr class="my-4">

        <!-- Social icons -->
        <div class="pb-4">
            <a href="https://github.com/edisonlee55/MoeMarry">
                <i class="fab fa-github mr-3"></i>
            </a>

        </div>
        <!-- Social icons -->

        <!--Copyright-->
        <div class="footer-copyright py-3">
            Copyright ¬© 2018 Edison Lee
        </div>
        <!--/.Copyright-->

    </footer>
    <!--/.Footer-->

    <!-- SCRIPTS -->
    <!-- JQuery -->
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="js/mdb.min.js"></script>
    <!-- web3 -->
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="https://cdn.edisonlee55.com/lib/js/browser-solc.min.js" type="text/javascript"></script>
    <!-- Initializations -->
    <script type="text/javascript">
        // Animations initialization
        new WOW().init();

        window.addEventListener('load', function () {

            // Checking if Web3 has been injected by the browser (Mist/MetaMask)
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                // set the provider you want from Web3.providers
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }

            if (web3.currentProvider.isMetaMask) {
                $("#onlineStatus").css("background", "#80c97e");
                $("#statusText").text('Web3: MetaMask connected!');
                web3.version.getNetwork((err, netId) => {
                    switch (netId) {
                        case "1":
                            $("#netStatus").text('Network: mainnet');
                            break;
                        case "2":
                            $("#netStatus").text('Network: deprecated Morden test network');
                            break;
                        case "3":
                            $("#netStatus").text('Network: ropsten test network');
                            break;
                        case "4":
                            $("#netStatus").text('Network: Rinkeby test network');
                            break;
                        case "42":
                            $("#netStatus").text('Network: Kovan test network');
                            break;
                        default:
                            $("#netStatus").text('Network: Unknown');
                    }
                });
                var account = web3.eth.accounts[0];
                $("#address").text("Address: " + account);
                var accountInterval = setInterval(function () {
                    if (web3.eth.accounts[0] !== account) {
                        account = web3.eth.accounts[0];
                        $("#address").text("Address: " + account);
                    }
                }, 100);
            } else {
                $("#statusText").text('Web3: MetaMask not connected!');
                $("#formBody").html('<h1 style="text-align:center;">Êú™ÂÅµÊ∏¨Âà∞ MetaMask!</h1><p style="text-align:center">Ë´ãÈªûÈÅ∏<a href="https://metamask.io/">Êú¨ÈÄ£Áµê</a>Âà∞ MetaMask ÂÆòÁ∂≤‰∏ãËºâ‰∏¶Âª∫Á´ã‰Ω†ÁöÑÈå¢ÂåÖ!');
            }
        });

        function recordMarriage() {
            $("#partner1").removeClass("invalid");
            $("#partner2").removeClass("invalid");
            $("#marriageDate").removeClass("invalid");
            var partner1 = $("#partner1").val();
            var partner2 = $("#partner2").val();
            var marriageDate = $("#marriageDate").val();
            if (partner1 != "" && partner2 != "" && marriageDate != "") {
                var dateTime = new Date(marriageDate).getTime();
                var timestamp = Math.floor(dateTime / 1000);

                BrowserSolc.loadVersion("soljson-v0.4.24+commit.e67f0147.js", function (compiler) {
                    source = `pragma solidity ^0.4.24; contract owned { address public owner; constructor() public { owner = msg.sender; } modifier onlyOwner { require(msg.sender == owner); _; } function transferOwnership(address newOwner) onlyOwner public { owner = newOwner; } } contract Marriage is owned { bytes32 public partner1; bytes32 public partner2; uint256 public marriageDate; bytes32 public marriageStatus; bytes public imageHash; bytes public marriageProofDoc; constructor() public { createMarriage(); } function createMarriage() onlyOwner public { partner1 = "${partner1}"; partner2 = "${partner2}"; marriageDate = ${timestamp}; setStatus("Married"); bytes32 name = "Marriage Contract Creation"; majorEventFunc(marriageDate, name, "We got married!"); } function setStatus(bytes32 status) onlyOwner public { marriageStatus = status; majorEventFunc(block.timestamp, "Changed Status", status); } function setImage(bytes IPFSImageHash) onlyOwner public { imageHash = IPFSImageHash; majorEventFunc(block.timestamp, "Entered Marriage Image", "Image is in IPFS"); } function marriageProof(bytes IPFSProofHash) onlyOwner public { marriageProofDoc = IPFSProofHash; majorEventFunc(block.timestamp, "Entered Marriage Proof", "Marriage proof in IPFS"); } function majorEventFunc(uint256 eventTimeStamp, bytes32 name, bytes32 description) public { emit MajorEvent(block.timestamp, eventTimeStamp, name, description); } event MajorEvent(uint256 logTimeStamp, uint256 eventTimeStamp, bytes32 indexed name, bytes32 indexed description); function () public { revert(); } }`;
                    optimize = 1;
                    result = compiler.compile(source, optimize);
                    var resultBytecode = (result.contracts[":Marriage"].bytecode);
                    web3.eth.sendTransaction({ data: resultBytecode }, function (err, transactionHash) {
                        if (!err)
                            //TODO: Change etherscan URL„ÄÄbetween different network
                            $("#TxID").html('TxID: <a href="https://etherscan.io/tx/' + transactionHash + '">' + transactionHash + '</a> (Ë´ã‰øùÂ≠òÊ≠§ TxID ‰ª•ËøΩËπ§ÁµêÂ©öÁ¥ÄÈåÑ)');
                    });
                });
            } else {
                if (partner1 == "") {
                    $("#partner1").addClass("invalid");
                }
                if (partner2 == "") {
                    $("#partner2").addClass("invalid");
                }
                if (marriageDate == "") {
                    $("#marriageDate").addClass("invalid");
                }
            }


        }

        $("#recordMarriage").click(function (event) {
            recordMarriage();
            event.preventDefault();
        })

    </script>
</body>

</html>
